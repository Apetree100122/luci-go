{{define "title"}}
Project {{index (SplitSlash .Run.Id) 0}}
Run {{index (SplitSlash .Run.Id) 1}}
- LUCI Change Verifier
{{end}}

{{define "head"}}
<style type="text/css">
table {
  table-layout: fixed;
  border-collapse: collapse;
}
table td{
  padding: 2px 8px;
}
table td.long {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.collapsible{
  padding: 0 18px;
  display: none;
  overflow: hidden;
  background-color: #f1f1f1;
}

.active, .clickable:hover {
  background-color: #ccc;
}

div.clickable {
  padding: 10px;
  border: 2px;
  border-color: black;
  font-weight: bold;
}

#full-details-panel{
  margin-left: 50px;
}


.tryjob-chips ul li{
  padding: 2px 4px;
  margin: 2px 4px;
}
.tryjob-chips {
  line-height: 2;
}
.tryjob-chip {
  color: black;
  font-size: 90%;
  border: solid 1px rgba(0, 0, 0, 0.5);
  border-radius: 3px;
  padding: 2px 4px;
}
.tryjob-chip.highlight {
  box-shadow: gray 1.5px 1.5px 1px;
  text-decoration: underline;
  color: blue;
}
.tryjob-chip.highlight:visited {
  color: purple;
}
.tryjob-chip.unexpected {
  background: #f0f;
}
.tryjob-chip.not-started {
  background: #eee;
}
.tryjob-chip.running {
  background: #ff7;
}
.tryjob-chip.passed {
  background: #9e6;
}
.tryjob-chip.failed {
  background: #e88;
}


.message {
  overflow: auto;
  max-height: 250px;
  background-color: white;
  padding: 10px 50px;
}

.cl-list {
  padding-right: 50px;
  max-height: 600px;
  overflow-y: auto;
}

</style>

{{end}}

{{define "content"}}
{{$TJProgression := .TJProgression}}
{{$RelTime := .RelTime}}
{{$AllTryjobs := .AllTryjobs}}
{{$LogMessage := .LogMessage}}
<div class="container">
  <div>
      <h3>Run details</h3>
        {{template "runDetails" .Run}}
        {{$Created := .Run.CreateTime.AsTime}}
  </div>

  <div style="width: fit-content;">
    <h3>CLs</h3>
  <div class="cl-list">
    <ul>
    {{range .Cls}}
      {{if .Detail.GetGerrit}}
        <li>
          ({{- .Detail.GetGerrit.Host -}}/{{- .Detail.GetGerrit.Info.Number -}}/{{- .Detail.Patchset -}})
          <a href="{{.ExternalID.URL}}">
            <!-- Use the first line of the commit message as link text. -->
            {{with .Detail.GetGerrit}}
              {{(index (Split (index .Info.Revisions .Info.CurrentRevision).Commit.Message) 0)}}
            {{end}}
          </a>
        </li>
      {{end}}
    {{end}}
    </ul>
  </div>
  </div>


  <div>
    <h3>Tryjobs</h3>
    <div>
      <p><b>NOTE</b> color codes represent how CV sees tryjobs (triggered | failed | succeeded),
      which isn't as granular as Buildbucket's statuses.</p>
      <p class="tryjob-chips">
        {{range $AllTryjobs}}
          {{with UITryjob .}}
            <a class="tryjob-chip {{.Class}}" href="{{.Link}}">{{.Display}}</a>
            <span> </span>
          {{end}}
        {{end}}
        </p>
      </div>
    {{if .Logs}}
      <h3>Logs</h3>
      <table class="table table-striped">
        <thead>
          <th style="width: 200px;">Event</th>
          <th style="width: 250px;">Time</th>
          <th style="width: 100px;">&nbsp;</th>
          <th>&nbsp;</th>
        </thead> <tbody>
          {{range .Logs}}
            <tr class="log-entry{{if .GetTryjobsUpdated}}-top{{end}}">
              <td><em>{{LogTypeString .}}</em></td>
              <td>{{FmTime .GetTime.AsTime}} </td>
              <td>{{call $RelTime .GetTime.AsTime}} </td>
              <td>
                {{if (call $LogMessage .)}}
                  <div class="message"><pre>{{call $LogMessage .}}</pre></div>
                {{end}}
              </td>
            </tr>
            {{if .GetTryjobsUpdated}}
              <tr class="log-entry-bottom">
                {{with .GetTryjobsUpdated}}
                  <td class="tryjob-chips" colspan="4">
                    <ul>
                    {{range $label, $jobs := ByTryjobStatus .GetTryjobs}}
                      <li>{{$label}}:
                      {{range $jobs}}
                        {{with UITryjob .}}
                        <a class="tryjob-chip {{.Class}}" href="{{.Link}}">{{.Display}}</a>
                        <span> </span>
                        {{end}}
                      {{end}}
                      </li>
                    {{end}}
                    </ul>
                  </td>
                {{end}}
              </tr>
            {{end}}
          {{end}}
        </tbody>
    </table>
  {{end}}
  </div>


</div>
{{end}}

{{define "runDetails"}}
<div>
  <table class="table run-details">
    <thead>
      <tr>
        <th style="width: 10%;">PROJECT</th>
        <th style="width: 25%;">ID</th>
        <th style="width: 10%;">MODE</th>
        <th style="width: 10%;">STATUS</th>
        <th>&nbsp;</th>
      </tr>
    </thead>
    <tbody>
      <tr>
      <td>{{index (SplitSlash .Id) 0}}</td>
      <td><b>{{index (SplitSlash .Id) 1}}</b></td>
      <td>{{.Mode}}</td>
      <td>{{.Status}}</td>
      <td>
        <div id="run-details-expander" class="clickable"> (+) Show details</div>
        <div id="run-details-collapser" class="collapsible">(-) Hide details</div>
      </td>
      </tr>
    </tbody>
  </table>

  <div id="full-details-panel" class="collapsible well">
  <dl class="dl-horizontal">
  <dt>Eversion:</dt><dd>{{.Eversion}}</dd>
  <dt>Id:</dt><dd>{{.Id}}</dd>
  <dt>Mode:</dt><dd>{{.Mode}}</dd>
  <dt>Status:</dt><dd>{{.Status}}</dd>
  <dt>CreateTime:</dt><dd>{{FmTime .CreateTime.AsTime}}</dd>
  <dt>StartTime:</dt><dd>{{FmTime .StartTime.AsTime}}</dd>
  <dt>UpdateTime:</dt><dd>{{FmTime .UpdateTime.AsTime}}</dd>
  <dt>EndTime:</dt><dd>{{FmTime .EndTime.AsTime}}</dd>
  <dt>Owner:</dt><dd>{{.Owner}}</dd>
  <dt>ConfigGroupId:</dt><dd>{{.ConfigGroupId}}</dd>
  </dl>
  </div>
</div>
{{template "collapserScript"}}
{{end}}

{{define "collapserScript"}}
  <script>
  var expander = document.getElementById("run-details-expander");
  var collapser = document.getElementById("run-details-collapser");
  var collapsible = document.getElementById("full-details-panel");

  function toggler(){
    collapsible.classList.toggle("collapsible");
    collapser.classList.toggle("collapsible")
    collapser.classList.toggle("clickable");
    expander.classList.toggle("collapsible")
    expander.classList.toggle("clickable");
  }

  expander.addEventListener("click", toggler);
  collapser.addEventListener("click", toggler);
  </script>
{{end}}
