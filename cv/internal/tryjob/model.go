// Copyright 2021 The LUCI Authors.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package tryjob

import (
	"time"

	"go.chromium.org/luci/gae/service/datastore"

	"go.chromium.org/luci/cv/internal/common"
)

const (
	// TryjobKind is the Datastore entity kind for Tryjob.
	TryjobKind = "Tryjob"
)

// Tryjob is an entity tracking CV Tryjobs.
type Tryjob struct {
	// $kind must match TryjobKind.
	_kind  string                `gae:"$kind,Tryjob"`
	_extra datastore.PropertyMap `gae:"-,extra"`

	// ID is the Tryjob ID, autogenerated by the Datastore.
	ID common.TryjobID `gae:"$id"`
	// ExternalID is a Tryjob ID in external system, e.g. Buildbucket.
	//
	// There can be several Tryjobs with the same ExternalID,
	// though typically just 1.
	//
	// Indexed.
	ExternalID ExternalID
	// EVersion is the entity version.
	//
	// It increments by one upon every successful modification.
	EVersion int `gae:",noindex"`
	// EntityCreateTime is the timestamp when this entity was created.
	//
	// NOTE: this is not the backend's tryjob creation time,
	// which is stored in .Result.CreateTime.
	EntityCreateTime time.Time `gae:",noindex"`
	// UpdateTime is the timestamp when this entity was last updated.
	//
	// NOTE: this is not the backend's tryjob update time,
	// which is stored in .Result.UpdateTime.
	EntityUpdateTime time.Time `gae:",noindex"`

	// CLPSs are all (CL, PS) referenced by this Tryjob.
	//
	// Immutable.
	// Indexed.
	// Sorted.
	// TODO(crbug/1227363): define efficient encoding of (CL, PS) tuple
	// such it can be efficiently searched for during cancelation
	// and other CV needs.
	// CLPSs  common.CLPSs.

	// Definition of the tryjob.
	//
	// Immutable.
	Definition *Definition

	// Status of the Tryjob.
	//
	// Indexed.
	Status Status

	// TriggeredByCV is true if it was triggered by CV.
	//
	// This is used for cancelation, since CV shouldn't cancel tryjobs it didn't
	// trigger.
	TriggeredByCV bool

	// Result of the Tryjob.
	//
	// Must be set if Status is ENDED.
	// May be set if Status is TRIGGERED.
	//
	// It's used by the Run Manager.
	Result *Result
}
